#include "driver/ws2812.h"



/***********************************************************************************/
//                 �ڲ���
/***********************************************************************************/
#define WS2812_OUT_0()    GPIO_OUTPUT_SET( GPIO_ID_PIN(WS2812_PIN), 0 )
#define WS2812_OUT_1()    GPIO_OUTPUT_SET( GPIO_ID_PIN(WS2812_PIN), 1 )

#if 0
#define RGB_TO_GRB(c)   (uint32)((c&0x000000ff)|((c>>8)&0x0000ff00)|((c<<8)&0x00ff0000))
#else
#define RGB_TO_GRB(c)   c
#endif

#define GRB_TO_RGB(c)   RGB_TO_GRB(c)

/***********************************************************************************/
//                 �ڲ�ȫ�ֱ���
/***********************************************************************************/
//���ص㻺��
static uint32 cBuff[PIXEL_MAX]={0};

/***********************************************************************************/
//                 �ڲ�����
/***********************************************************************************/
uint32 ws2812_rgb_to_grb( uint32 c )
{    
    return (uint32)(c&0x000000ff|(c>>8)&0x0000ff00|(c<<8)&0x00ff0000);
}

/***********************************************************************************/
//                 �ⲿ����
/***********************************************************************************/
/*****************************************************************************
 * �� �� ��  : WS2812_Init
 * ��������  : ��ʼ��ws2812
 * �������  : ��
 * �� �� ֵ  : ��
 * ��    ע  : ��                
*****************************************************************************/
void IFA WS2812_Init( void )
{
	PIN_FUNC_SELECT(WS2812_MUX, WS2812_FUN);
    WS2812_SetFillColor(0,0,0);
    WS2812_SetFillColor(255,0,0);
}

/*****************************************************************************
 * �� �� ��  : WS2812_Send24bit
 * ��������  : ����24bit���ݵ�ws2812
 * �������  : 
                color : 32λ��ɫֵ;wgrb;wΪ�Ҷ�(������)
 * �� �� ֵ  : ��
 * ��    ע  : ��                
*****************************************************************************/
void  IRAM_ATTR WS2812_Send24bit( uint32 color )
{
	uint32 mask,time;    
    //24bit���ݷ���,�����ǰ
    mask = 0x00800000;        
    WS2812_OUT_0();
    while( mask ) 
    {
        if( color & mask )
        {//����1
            time = 7;
            while(time--) GPIO_REG_WRITE(GPIO_OUT_W1TS_ADDRESS, BIT(WS2812_PIN) );
            time = 5;
            while(time--) GPIO_REG_WRITE(GPIO_OUT_W1TC_ADDRESS, BIT(WS2812_PIN) );
        }
        else
        {//����0
            time = 3;
            while(time--) GPIO_REG_WRITE(GPIO_OUT_W1TS_ADDRESS, BIT(WS2812_PIN) );
            time = 8;
            while(time--) GPIO_REG_WRITE(GPIO_OUT_W1TC_ADDRESS, BIT(WS2812_PIN) );
        }
        mask >>= 1;
    }   
}

/*****************************************************************************
 * �� �� ��  : WS2812_RefreshShow
 * ��������  : ˢ��ȫ�����ص�
 * �������  : ��
 * �� �� ֵ  : ��
 * ��    ע  : ��                
*****************************************************************************/
void IFA WS2812_RefreshShow( void )
{    
	uint32 i;    	

	ETS_INTR_LOCK();	

    for( i=0; i<PIXEL_MAX; i++ )
    {   
        WS2812_Send24bit(cBuff[i]);
    }     		

    ETS_INTR_UNLOCK();
    
    WS2812_DELAY();
}

/*****************************************************************************
 * �� �� ��  : WS2812_SetPixelColor
 * ��������  : ���õ������ص���ɫ
 * �������  : 
                color   : ��ɫֵ
                n       : ���ص�λ��
 * �� �� ֵ  : 
                0 : ʧ��
                1 : �ɹ�
 * ��    ע  : ��                
*****************************************************************************/
uint8 IFA WS2812_SetPixelColor( uint32 color , uint16 n )
{	  
    if( n>=PIXEL_MAX ) return 0;    
    cBuff[n] = RGB_TO_GRB(color);    
    WS2812_RefreshShow();  
    return 1;
}


/*****************************************************************************
 * �� �� ��  : WS2812_SetFillColor
 * ��������  : ���ȫ�����ص���ɫ
 * �������  :                 
                color : ��ɫֵ
 * �� �� ֵ  : ��
 * ��    ע  : ��                
*****************************************************************************/
void WS2812_SetFillColor(int r, int g, int b) {

	uint32 color = (uint32) (((uint32_t) r << 16) | ((uint32_t) g << 8) | b);

	uint16 i = 0;
	for (i = 0; i < PIXEL_MAX; i++) {
		cBuff[i] = RGB_TO_GRB(color);
	}
	WS2812_RefreshShow();

}


/*****************************************************************************
 * �� �� ��  : WS2812_GetColorBuff
 * ��������  : ��ȡ��ɫ����
 * �������  :                 
                *colorBuff : ��ɫ����ָ��
 * �� �� ֵ  : ��
 * ��    ע  : ��                
*****************************************************************************/
void IFA WS2812_GetColorBuff( COLOR_BUFF *colorBuff )
{    
    uint16 i;
    for( i=0; i<PIXEL_MAX; i++ )
    {
        colorBuff->at[i].c = GRB_TO_RGB(cBuff[i]);
    }
}

/*****************************************************************************
 * �� �� ��  : WS2812_SetColorBuff
 * ��������  : ������ɫ����,��ˢ����ʾ
 * �������  :                 
                *colorBuff : ��ɫ����ָ��
 * �� �� ֵ  : ��
 * ��    ע  : ��                
*****************************************************************************/
void IFA WS2812_SetColorBuff( const COLOR_BUFF *colorBuff )
{    
    uint16 i;
    for( i=0; i<PIXEL_MAX; i++ )
    {
        cBuff[i] = RGB_TO_GRB(colorBuff->at[i].c);
    }
    WS2812_RefreshShow();
}



